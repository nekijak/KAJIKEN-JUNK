// Copyright 2006 Google Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
// implied. See the License for the specific language governing
// permissions and limitations under the License.
/**
 * Apache License, Version 2.0
 * Modify:Global variable -> in jstmpl object.
 *        Merge util.js, jsevalcontext.js, jstemplate.js.
 * @author K.Kajino
 */
// Global Object. this only.
var jstmpl={MAPS_DEBUG:!1,log:function(){},STRING_empty:"",CSS_display:"display",CSS_position:"position",TYPE_boolean:"boolean",TYPE_number:"number",TYPE_object:"object",TYPE_string:"string",TYPE_function:"function",TYPE_undefined:"undefined",DOM_ELEMENT_NODE:1,DOM_ATTRIBUTE_NODE:2,DOM_TEXT_NODE:3,DOM_CDATA_SECTION_NODE:4,DOM_ENTITY_REFERENCE_NODE:5,DOM_ENTITY_NODE:6,DOM_PROCESSING_INSTRUCTION_NODE:7,DOM_COMMENT_NODE:8,DOM_DOCUMENT_NODE:9,DOM_DOCUMENT_TYPE_NODE:10,DOM_DOCUMENT_FRAGMENT_NODE:11,DOM_NOTATION_NODE:12,VAR_index:"$index",VAR_count:"$count",VAR_this:"$this",VAR_context:"$context",VAR_top:"$top",GLOB_default:"$default",CHAR_colon:":",REGEXP_semicolon:/\s*;\s*/,STRING_a:"a_",STRING_b:"b_",STRING_with:"with (a_) with (b_) return ",ATT_select:"jsselect",ATT_instance:"jsinstance",ATT_display:"jsdisplay",ATT_values:"jsvalues",ATT_vars:"jsvars",ATT_eval:"jseval",ATT_transclude:"transclude",ATT_content:"jscontent",ATT_skip:"jsskip",ATT_jstcache:"jstcache",PROP_jstcache:"__jstcache",STRING_jsts:"jsts",CHAR_asterisk:"*",CHAR_dollar:"$",CHAR_period:".",CHAR_ampersand:"&",STRING_div:"div",STRING_id:"id",STRING_asteriskzero:"*0",STRING_zero:"0",jsEval:function(a){try{return eval("["+a+"][0]")}catch(b){return jstmpl.log("EVAL FAILED "+a+": "+b),null}},jsLength:function(a){return a.length},assert:function(){},copyProperties:function(a,b){for(var c in b)a[c]=b[c]},getDefaultObject:function(a,b){return jstmpl.TYPE_undefined!=typeof a&&null!=a?a:b},isArray:function(a){return null!=a&&jstmpl.TYPE_object==typeof a&&jstmpl.TYPE_number==typeof a.length},arraySlice:function(a,b,c){return Function.prototype.call.apply(Array.prototype.slice,arguments)},parseInt10:function(a){return parseInt(a,10)},arrayClear:function(a){a.length=0},bindFully:function(a,b,c){var d=jstmpl.arraySlice(arguments,2);return function(){return b.apply(a,d)}},domGetElementById:function(a,b){return a.getElementById(b)},domCreateElement:function(a,b){return a.createElement(b)},domTraverseElements:function(a,b){(new jstmpl.DomTraverser(b)).run(a)},DomTraverser:function(a){this.callback_=a},domGetAttribute:function(a,b){return a.getAttribute(b)},domSetAttribute:function(a,b,c){a.setAttribute(b,c)},domRemoveAttribute:function(a,b){a.removeAttribute(b)},domCloneNode:function(a){return a.cloneNode(!0)},domCloneElement:function(a){return jstmpl.domCloneNode(a)},ownerDocument:function(a){return!a?document:jstmpl.DOM_DOCUMENT_NODE==a.nodeType?a:a.ownerDocument||document},domCreateTextNode:function(a,b){return a.createTextNode(b)},domAppendChild:function(a,b){return a.appendChild(b)},displayDefault:function(a){a.style[jstmpl.CSS_display]=""},displayNone:function(a){a.style[jstmpl.CSS_display]="none"},positionAbsolute:function(a){a.style[jstmpl.CSS_position]="absolute"},domInsertBefore:function(a,b){return b.parentNode.insertBefore(a,b)},domReplaceChild:function(a,b){return b.parentNode.replaceChild(a,b)},domRemoveNode:function(a){return jstmpl.domRemoveChild(a.parentNode,a)},domRemoveChild:function(a,b){return a.removeChild(b)},stringTrim:function(a){return jstmpl.stringTrimRight(jstmpl.stringTrimLeft(a))},stringTrimLeft:function(a){return a.replace(/^\s+/,"")},stringTrimRight:function(a){return a.replace(/\s+$/,"")},jsEvalToFunction:function(a){if(!jstmpl.JsEvalContext.evalToFunctionCache_[a])try{jstmpl.JsEvalContext.evalToFunctionCache_[a]=new Function(jstmpl.STRING_a,jstmpl.STRING_b,jstmpl.STRING_with+a)}catch(b){jstmpl.log("jsEvalToFunction ("+a+") EXCEPTION "+b)}return jstmpl.JsEvalContext.evalToFunctionCache_[a]},jsEvalToSelf:function(a){return a},jsEvalToValues:function(a){var b=[];a=a.split(jstmpl.REGEXP_semicolon);for(var c=0,d=jstmpl.jsLength(a);c<d;++c){var e=a[c].indexOf(jstmpl.CHAR_colon);if(!(0>e)){var f=jstmpl.stringTrim(a[c].substr(0,e)),e=jstmpl.jsEvalToFunction(a[c].substr(e+1));b.push(f,e)}}return b},jsEvalToExpressions:function(a){var b=[];a=a.split(jstmpl.REGEXP_semicolon);for(var c=0,d=jstmpl.jsLength(a);c<d;++c)if(a[c]){var e=jstmpl.jsEvalToFunction(a[c]);b.push(e)}return b},JsEvalContext:function(a,b){this.constructor_.apply(this,arguments)},jstGetTemplate:function(a,b){var c=document;return(c=b?jstmpl.jstLoadTemplateIfNotPresent(c,a,b):jstmpl.domGetElementById(c,a))?(jstmpl.JstProcessor.prepareTemplate_(c),c=jstmpl.domCloneElement(c),jstmpl.domRemoveAttribute(c,jstmpl.STRING_id),c):null},jstGetTemplateOrDie:function(a,b){var c=jstmpl.jstGetTemplate(a,b);check(null!==c);return c},jstLoadTemplateIfNotPresent:function(a,b,c,d){var e=jstmpl.domGetElementById(a,b);if(e)return e;jstmpl.jstLoadTemplate_(a,c(),d||jstmpl.STRING_jsts);(e=jstmpl.domGetElementById(a,b))||jstmpl.log("Error: jstmpl.jstGetTemplate was provided with opt_loadHtmlFn, but that function did not provide the id '"+b+"'.");return e},jstLoadTemplate_:function(a,b,c){var d=jstmpl.domGetElementById(a,c);d||(d=jstmpl.domCreateElement(a,jstmpl.STRING_div),d.id=c,jstmpl.displayNone(d),jstmpl.positionAbsolute(d),jstmpl.domAppendChild(a.body,d));a=jstmpl.domCreateElement(a,jstmpl.STRING_div);d.appendChild(a);a.innerHTML=b},jstSetInstance:function(a,b,c){c==jstmpl.jsLength(b)-1?jstmpl.domSetAttribute(a,jstmpl.ATT_instance,jstmpl.CHAR_asterisk+c):jstmpl.domSetAttribute(a,jstmpl.ATT_instance,jstmpl.STRING_empty+c)}};jstmpl.DomTraverser.prototype.run=function(a){for(this.queue_=[a];jstmpl.jsLength(this.queue_);)this.process_(this.queue_.shift())};jstmpl.DomTraverser.prototype.process_=function(a){this.callback_(a);for(a=a.firstChild;a;a=a.nextSibling)jstmpl.DOM_ELEMENT_NODE==a.nodeType&&this.queue_.push(a)};jstmpl.JsEvalContext.prototype.constructor_=function(a,b){this.vars_||(this.vars_={});b?jstmpl.copyProperties(this.vars_,b.vars_):jstmpl.copyProperties(this.vars_,jstmpl.JsEvalContext.globals_);this.vars_[jstmpl.VAR_this]=a;this.vars_[jstmpl.VAR_context]=this;this.data_=jstmpl.getDefaultObject(a,jstmpl.STRING_empty);b||(this.vars_[jstmpl.VAR_top]=this.data_)};jstmpl.JsEvalContext.globals_={};jstmpl.JsEvalContext.setGlobal=function(a,b){jstmpl.JsEvalContext.globals_[a]=b};jstmpl.JsEvalContext.setGlobal(jstmpl.GLOB_default,null);jstmpl.JsEvalContext.recycledInstances_=[];jstmpl.JsEvalContext.create=function(a,b){if(0<jstmpl.jsLength(jstmpl.JsEvalContext.recycledInstances_)){var c=jstmpl.JsEvalContext.recycledInstances_.pop();jstmpl.JsEvalContext.call(c,a,b);return c}return new jstmpl.JsEvalContext(a,b)};jstmpl.JsEvalContext.recycle=function(a){for(var b in a.vars_)delete a.vars_[b];a.data_=null;jstmpl.JsEvalContext.recycledInstances_.push(a)};jstmpl.JsEvalContext.prototype.jsexec=function(a,b){try{return a.call(b,this.vars_,this.data_)}catch(c){return jstmpl.log("jsexec EXCEPTION: "+c+" at "+b+" with "+a),jstmpl.JsEvalContext.globals_[jstmpl.GLOB_default]}};jstmpl.JsEvalContext.prototype.clone=function(a,b,c){a=jstmpl.JsEvalContext.create(a,this);a.setVariable(jstmpl.VAR_index,b);a.setVariable(jstmpl.VAR_count,c);return a};jstmpl.JsEvalContext.prototype.setVariable=function(a,b){this.vars_[a]=b};jstmpl.JsEvalContext.prototype.getVariable=function(a){return this.vars_[a]};jstmpl.JsEvalContext.prototype.evalExpression=function(a,b){var c=jstmpl.jsEvalToFunction(a);return this.jsexec(c,b)};jstmpl.JsEvalContext.evalToFunctionCache_={};jstmpl.jstProcess=function(a,b,c){var d=new jstmpl.JstProcessor;jstmpl.MAPS_DEBUG&&c&&d.setDebugging(c);jstmpl.JstProcessor.prepareTemplate_(b);d.document_=jstmpl.ownerDocument(b);d.run_(jstmpl.bindFully(d,d.jstProcessOuter_,a,b));jstmpl.MAPS_DEBUG&&c&&jstmpl.log("jstProcess:\n"+d.getLogs().join("\n"))};jstmpl.JstProcessor=function(){jstmpl.MAPS_DEBUG&&(this.logs_=[])};jstmpl.JstProcessor.jstid_=0;jstmpl.JstProcessor.jstcache_={};jstmpl.JstProcessor.jstcache_[0]={};jstmpl.JstProcessor.jstcacheattributes_={};jstmpl.JstProcessor.attributeValues_={};jstmpl.JstProcessor.attributeList_=[];jstmpl.JstProcessor.prepareTemplate_=function(a){a[jstmpl.PROP_jstcache]||jstmpl.domTraverseElements(a,function(a){jstmpl.JstProcessor.prepareNode_(a)})};jstmpl.JST_ATTRIBUTES=[[jstmpl.ATT_select,jstmpl.jsEvalToFunction],[jstmpl.ATT_display,jstmpl.jsEvalToFunction],[jstmpl.ATT_values,jstmpl.jsEvalToValues],[jstmpl.ATT_vars,jstmpl.jsEvalToValues],[jstmpl.ATT_eval,jstmpl.jsEvalToExpressions],[jstmpl.ATT_transclude,jstmpl.jsEvalToSelf],[jstmpl.ATT_content,jstmpl.jsEvalToFunction],[jstmpl.ATT_skip,jstmpl.jsEvalToFunction]];jstmpl.JstProcessor.prepareNode_=function(a){if(a[jstmpl.PROP_jstcache])return a[jstmpl.PROP_jstcache];var b=jstmpl.domGetAttribute(a,jstmpl.ATT_jstcache);if(null!=b)return a[jstmpl.PROP_jstcache]=jstmpl.JstProcessor.jstcache_[b];for(var c=jstmpl.JstProcessor.attributeValues_,d=jstmpl.JstProcessor.attributeList_,b=d.length=0,e=jstmpl.jsLength(jstmpl.JST_ATTRIBUTES);b<e;++b){var f=jstmpl.JST_ATTRIBUTES[b][0],g=jstmpl.domGetAttribute(a,f);c[f]=g;null!=g&&d.push(f+"="+g)}if(0==d.length)return jstmpl.domSetAttribute(a,jstmpl.ATT_jstcache,jstmpl.STRING_zero),a[jstmpl.PROP_jstcache]=jstmpl.JstProcessor.jstcache_[0];d=d.join(jstmpl.CHAR_ampersand);if(b=jstmpl.JstProcessor.jstcacheattributes_[d])return jstmpl.domSetAttribute(a,jstmpl.ATT_jstcache,b),a[jstmpl.PROP_jstcache]=jstmpl.JstProcessor.jstcache_[b];for(var h={},b=0,e=jstmpl.jsLength(jstmpl.JST_ATTRIBUTES);b<e;++b){var g=jstmpl.JST_ATTRIBUTES[b],f=g[0],j=g[1],g=c[f];null!=g&&(h[f]=j(g),jstmpl.MAPS_DEBUG&&(h.jstAttributeValues=h.jstAttributeValues||{},h.jstAttributeValues[f]=g))}b=jstmpl.STRING_empty+ ++jstmpl.JstProcessor.jstid_;jstmpl.domSetAttribute(a,jstmpl.ATT_jstcache,b);jstmpl.JstProcessor.jstcache_[b]=h;jstmpl.JstProcessor.jstcacheattributes_[d]=b;return a[jstmpl.PROP_jstcache]=h};jstmpl.JstProcessor.prototype.run_=function(a){var b=this.calls_=[],c=this.queueIndices_=[];this.arrayPool_=[];a();for(var d,e,f;b.length;)d=b[b.length-1],a=c[c.length-1],a>=d.length?(this.recycleArray_(b.pop()),c.pop()):(e=d[a++],f=d[a++],d=d[a++],c[c.length-1]=a,e.call(this,f,d))};jstmpl.JstProcessor.prototype.push_=function(a){this.calls_.push(a);this.queueIndices_.push(0)};jstmpl.JstProcessor.prototype.setDebugging=function(a){jstmpl.MAPS_DEBUG&&(this.debugging_=a)};jstmpl.JstProcessor.prototype.createArray_=function(){return this.arrayPool_.length?this.arrayPool_.pop():[]};jstmpl.JstProcessor.prototype.recycleArray_=function(a){jstmpl.arrayClear(a);this.arrayPool_.push(a)};jstmpl.JstProcessor.prototype.jstProcessOuter_=function(a,b){var c=this.jstAttributes_(b);jstmpl.MAPS_DEBUG&&this.debugging_&&this.logState_("Outer",b,c.jstAttributeValues);var d=c[jstmpl.ATT_transclude];d?(c=jstmpl.jstGetTemplate(d))?(jstmpl.domReplaceChild(c,b),d=this.createArray_(),d.push(this.jstProcessOuter_,a,c),this.push_(d)):jstmpl.domRemoveNode(b):(c=c[jstmpl.ATT_select])?this.jstSelect_(a,b,c):this.jstProcessInner_(a,b)};jstmpl.JstProcessor.prototype.jstProcessInner_=function(a,b){var c=this.jstAttributes_(b);jstmpl.MAPS_DEBUG&&this.debugging_&&this.logState_("Inner",b,c.jstAttributeValues);var d=c[jstmpl.ATT_display];if(d){d=a.jsexec(d,b);jstmpl.MAPS_DEBUG&&this.debugging_&&this.logs_.push(jstmpl.ATT_display+": "+d+"<br/>");if(!d){jstmpl.displayNone(b);return}jstmpl.displayDefault(b)}(d=c[jstmpl.ATT_vars])&&this.jstVars_(a,b,d);(d=c[jstmpl.ATT_values])&&this.jstValues_(a,b,d);if(d=c[jstmpl.ATT_eval])for(var e=0,f=jstmpl.jsLength(d);e<f;++e)a.jsexec(d[e],b);if(d=c[jstmpl.ATT_skip])if(d=a.jsexec(d,b),jstmpl.MAPS_DEBUG&&this.debugging_&&this.logs_.push(jstmpl.ATT_skip+": "+d+"<br/>"),d)return;if(c=c[jstmpl.ATT_content])this.jstContent_(a,b,c);else{c=this.createArray_();for(d=b.firstChild;d;d=d.nextSibling)d.nodeType==jstmpl.DOM_ELEMENT_NODE&&c.push(this.jstProcessOuter_,a,d);c.length&&this.push_(c)}};jstmpl.JstProcessor.prototype.jstSelect_=function(a,b,c){c=a.jsexec(c,b);var d=jstmpl.domGetAttribute(b,jstmpl.ATT_instance),e=!1;d&&(d.charAt(0)==jstmpl.CHAR_asterisk?(d=jstmpl.parseInt10(d.substr(1)),e=!0):d=jstmpl.parseInt10(d));var f=jstmpl.isArray(c),g=f?jstmpl.jsLength(c):1,h=f&&0==g;if(f)if(h)d?jstmpl.domRemoveNode(b):(jstmpl.domSetAttribute(b,jstmpl.ATT_instance,jstmpl.STRING_asteriskzero),jstmpl.displayNone(b));else if(jstmpl.displayDefault(b),null===d||d===jstmpl.STRING_empty||e&&d<g-1){e=this.createArray_();d=d||0;for(f=g-1;d<f;++d){var j=jstmpl.domCloneNode(b);jstmpl.domInsertBefore(j,b);jstmpl.jstSetInstance(j,c,d);h=a.clone(c[d],d,g);e.push(this.jstProcessInner_,h,j,jstmpl.JsEvalContext.recycle,h,null)}jstmpl.jstSetInstance(b,c,d);h=a.clone(c[d],d,g);e.push(this.jstProcessInner_,h,b,jstmpl.JsEvalContext.recycle,h,null);this.push_(e)}else d<g?(e=c[d],jstmpl.jstSetInstance(b,c,d),h=a.clone(e,d,g),e=this.createArray_(),e.push(this.jstProcessInner_,h,b,jstmpl.JsEvalContext.recycle,h,null),this.push_(e)):jstmpl.domRemoveNode(b);else null==c?jstmpl.displayNone(b):(jstmpl.displayDefault(b),h=a.clone(c,0,1),e=this.createArray_(),e.push(this.jstProcessInner_,h,b,jstmpl.JsEvalContext.recycle,h,null),this.push_(e))};jstmpl.JstProcessor.prototype.jstVars_=function(a,b,c){for(var d=0,e=jstmpl.jsLength(c);d<e;d+=2){var f=c[d],g=a.jsexec(c[d+1],b);a.setVariable(f,g)}};jstmpl.JstProcessor.prototype.jstValues_=function(a,b,c){for(var d=0,e=jstmpl.jsLength(c);d<e;d+=2){var f=c[d],g=a.jsexec(c[d+1],b);if(f.charAt(0)==jstmpl.CHAR_dollar)a.setVariable(f,g);else if(f.charAt(0)==jstmpl.CHAR_period){for(var f=f.substr(1).split(jstmpl.CHAR_period),h=b,j=jstmpl.jsLength(f),k=0,m=j-1;k<m;++k){var l=f[k];h[l]||(h[l]={});h=h[l]}h[f[j-1]]=g}else f&&(typeof g==jstmpl.TYPE_boolean?g?jstmpl.domSetAttribute(b,f,f):jstmpl.domRemoveAttribute(b,f):jstmpl.domSetAttribute(b,f,jstmpl.STRING_empty+g))}};jstmpl.JstProcessor.prototype.jstContent_=function(a,b,c){a=jstmpl.STRING_empty+a.jsexec(c,b);if(b.innerHTML!=a){for(;b.firstChild;)jstmpl.domRemoveNode(b.firstChild);a=jstmpl.domCreateTextNode(this.document_,a);jstmpl.domAppendChild(b,a)}};jstmpl.JstProcessor.prototype.jstAttributes_=function(a){if(a[jstmpl.PROP_jstcache])return a[jstmpl.PROP_jstcache];var b=jstmpl.domGetAttribute(a,jstmpl.ATT_jstcache);return b?a[jstmpl.PROP_jstcache]=jstmpl.JstProcessor.jstcache_[b]:jstmpl.JstProcessor.prepareNode_(a)};jstmpl.JstProcessor.prototype.logState_=function(a,b,c){jstmpl.MAPS_DEBUG&&(a="<table>"+("<caption>"+a+"</caption>")+"<tbody>",b.id&&(a+="<tr><td>id:</td><td>"+b.id+"</td></tr>"),b.name&&(a+="<tr><td>name:</td><td>"+b.name+"</td></tr>"),c&&(a+="<tr><td>attr:</td><td>"+jsToSource(c)+"</td></tr>"),a+="</tbody></table><br/>",this.logs_.push(a))};jstmpl.JstProcessor.prototype.getLogs=function(){return this.logs_};
